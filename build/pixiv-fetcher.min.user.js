// ==UserScript==
// @name           Pixiv Fetcher
// @version 1.1.2
// @copyright     Copyright (c) <2011-2013> Merun
// @license       MIT http://opensource.org/licenses/MIT
// @namespace     http://e-shuushuu.net
// @description   Add romanized artist name to Pixiv pages
// @include       http://www.pixiv.net/*
// @updateURL     https://github.com/RomainLK/pixiv-fetcher/raw/master/build/pixiv-fetcher.min.user.js
// @grant         GM_xmlhttpRequest 
// @grant         GM_getValue
// @grant         GM_setValue
// @grant         GM_deleteValue
// @require       http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js
// ==/UserScript==
/*global GM_xmlhttpRequest: true, GM_getValue: true, GM_setValue: true, GM_deleteValue: true*/
function render(a){"undefined"!=typeof jDialog&&jDialog.remove(),"undefined"!=typeof p&&p.remove();var b=a||!1,c='<div class="dialog" style="display: none;"><p><strong>Pixiv Fetcher</strong></p><div  id="pclose" class="close"></div><form id="pform"><input type="text" name="username" placeholder="Username" style="width:128px;"><br/><br/> <input type="password" name="password" placeholder="Password"> <div id="pnotif"></div><div class="action"><input id="psubmit" type="submit" name="left_column" value="Login" class="button"><input id="pcancel" value="Cancel" class="button remove"></div></form></div>',d='<div class="dialog" style="display: none;"><p><strong>Pixiv Fetcher</strong></p><div id="pclose" class="close"></div><form id="pform"><label for="romanji">Romanji:</label> <input type="text" name="romanji" placeholder="Romanji" style="width:128px;"><div id="pnotif"></div><div class="action"><input id="psubmit"  type="submit" name="left_column" value="Submit" class="button"><input id="pcancel" value="Cancel" class="button remove"></div></form><br><br><a href="javascript:void(0)" id="plogout" >Logout</a> </div>';username=GM_getValue("pUsername",null),password=GM_getValue("pPassword",null),null===username||null===password?(dialog=$.parseHTML(c),jDialog=$(dialog),jDialog.find("#pform").submit(function(){var a=jDialog.find('input[name="username"]').val(),b=jDialog.find('input[name="password"]').val();return GM_xmlhttpRequest({method:"POST",url:"http://pixivfetcher-claritism.rhcloud.com/user/session",headers:{"Content-type":"application/x-www-form-urlencoded"},data:"username="+a+"&password="+b,onload:function(c){200!==c.status?jDialog.find("#pnotif").text(c.responseText):(GM_setValue("pUsername",a),GM_setValue("pPassword",b),render(!0))}}),!1})):(dialog=$.parseHTML(d),jDialog=$(dialog),romanji=romanji||"",jDialog.find('input[name="romanji"]').val(romanji),jDialog.find("#pform").submit(function(){var a=jDialog.find('input[name="romanji"]').val();return GM_xmlhttpRequest({method:"POST",url:"http://pixivfetcher-claritism.rhcloud.com/artist",headers:{"Content-type":"application/x-www-form-urlencoded"},data:"username="+username+"&password="+password+"&pixivId="+id+"&romanji="+a,onload:function(b){200!==b.status?jDialog.find("#pnotif").text(b.responseText):(romanji=a,jDialog.find("#pnotif").text(b.responseText),render(!1))}}),!1})),jDialog.find("#plogout").click(function(){GM_deleteValue("pUsername"),GM_deleteValue("pPassword"),render(!0)}),jDialog.find(".close").click(function(){jDialog.hide()}),jDialog.find("#pcancel").click(function(){jDialog.hide()}),p=$("<div>").css({"font-style":"italic","font-size":"13px",cursor:"pointer"}),""===romanji?p.text("No romanji"):p.text(romanji),p.click(function(){jDialog.show()}),user.after(p),p.after(dialog),b&&jDialog.show()}var user=$(".user-link"),id,p,dialog,jDialog,username,password,romanji;if(user.length>0){id=user.attr("href").match(/\d/g).join("");var request="http://pixivfetcher-claritism.rhcloud.com/artist/"+id;GM_xmlhttpRequest({method:"GET",headers:{Referer:document.URL},url:request,onload:function(a){var b=JSON.parse(a.responseText);romanji=null!==b.romanji?b.romanji:"",render()}})}